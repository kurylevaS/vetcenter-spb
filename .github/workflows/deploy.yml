name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

env:
  NODE_VERSION: '20.x'

jobs:
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏ —Å–±–æ—Ä–∫–∞
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: false

      - name: Check formatting
        run: npm run format
        continue-on-error: false

      - name: Build project
        run: npm run build
        env:
          NEXT_PUBLIC_FRONT_BASE_URL: ${{ secrets.NEXT_PUBLIC_FRONT_BASE_URL }}
          NEXT_PUBLIC_FRONT_API_URL: ${{ secrets.NEXT_PUBLIC_FRONT_API_URL }}
          NEXT_PUBLIC_FRONT_PROXY_API_URL: ${{ secrets.NEXT_PUBLIC_FRONT_PROXY_API_URL }}
          # –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Å–±–æ—Ä–∫–∏

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
            .next
            public
            package.json
            package-lock.json
            next.config.js
            node_modules
          retention-days: 1

  # –î–µ–ø–ª–æ–π –Ω–∞ VPS
  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: .

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            mkdir -p /var/www/vetcenter-spb
            mkdir -p /var/www/vetcenter-spb/releases
            mkdir -p /var/www/vetcenter-spb/shared
          EOF

      - name: Create release directory
        run: |
          RELEASE_DIR="/var/www/vetcenter-spb/releases/$(date +%Y%m%d%H%M%S)"
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "mkdir -p $RELEASE_DIR && echo $RELEASE_DIR > /var/www/vetcenter-spb/current-release.txt"
        id: set-release-dir

      - name: Copy files to server
        run: |
          RELEASE_DIR=$(ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cat /var/www/vetcenter-spb/current-release.txt")
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.env*' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$RELEASE_DIR/

      - name: Copy build files to server
        run: |
          RELEASE_DIR=$(ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cat /var/www/vetcenter-spb/current-release.txt")
          rsync -avz \
            .next/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$RELEASE_DIR/.next/
          rsync -avz \
            public/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$RELEASE_DIR/public/
          rsync -avz \
            node_modules/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$RELEASE_DIR/node_modules/

      - name: Deploy on server
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            
            RELEASE_DIR=$(cat /var/www/vetcenter-spb/current-release.txt)
            APP_DIR="/var/www/vetcenter-spb"
            
            echo "üöÄ Starting deployment..."
            echo "Release directory: $RELEASE_DIR"
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–µ–ª–∏–∑–∞
            cd $RELEASE_DIR
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
            if [ ! -f "$APP_DIR/shared/.env.production" ]; then
              echo "‚ö†Ô∏è  Warning: .env.production not found in $APP_DIR/shared/"
              echo "Please create it manually or copy from existing release"
            else
              # –ö–æ–ø–∏—Ä—É–µ–º .env —Ñ–∞–π–ª
              cp $APP_DIR/shared/.env.production $RELEASE_DIR/.env.production
              echo "‚úÖ Environment file copied"
            fi
            
            # –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –Ω–∞ —Ç–µ–∫—É—â–∏–π —Ä–µ–ª–∏–∑
            ln -sfn $RELEASE_DIR $APP_DIR/current
            echo "‚úÖ Symlink created"
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2
            cd $APP_DIR/current
            pm2 restart vetcenter-spb || pm2 start ecosystem.config.js
            echo "‚úÖ Application restarted"
            
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–ª–∏–∑—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
            cd $APP_DIR/releases
            ls -t | tail -n +6 | xargs -r rm -rf
            echo "‚úÖ Old releases cleaned up"
            
            echo "üéâ Deployment completed successfully!"
          DEPLOY_SCRIPT

      - name: Verify deployment
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'VERIFY_SCRIPT'
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PM2
            pm2 status vetcenter-spb
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            sleep 5
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ Application is running"
            else
              echo "‚ùå Application is not responding"
              exit 1
            fi
          VERIFY_SCRIPT

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi

